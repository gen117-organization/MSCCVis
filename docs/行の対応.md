# GitDiffの出力文のパース
GitDiffの出力の具体例
```sh
@@ -3,7 +3,8 @@ def foo():
 print("old line")
-print("this line was removed")
+print("this line was added")
+print("another new line")
 print("unchanged line")
```
パースする関数
```python
def parse_diff_str(diff: str):
    diff_at_split = diff.split("@@")
    try:
        hunk_range_split = diff_at_split[1].replace("+", "").replace("-", "").split(" ")
        hunk = diff_at_split[2].split("\n")
        hunk_range_old = hunk_range_split[1]
        hunk_range_new = hunk_range_split[2]
        old_line_count = int(hunk_range_old.split(",")[0])
        new_line_count = int(hunk_range_new.split(",")[0])
    except:
        return None
    return hunk, old_line_count, new_line_count
```
出力結果
```sh
([' def foo():', ' print("old line")', '-print("this line was removed")', '+print("this line was added")', '+print("another new line")', ' print("unchanged line")', ''], 3, 3)
```


# 行の分類
行を以下の3つに分類する．
- **inserted_lines**: 挿入された行
- **deleted_lines**: 削除された行
- **modified_lines**: 修正された行

まず`+`が付いている行と`-`が付いている行を特定する.  
`+` -> `potential_inserted_lines`(新しいファイルの行数を挿入する).  
`-` -> `potential_deleted_lines`(古いファイルの行数を挿入する).  

その後実際に分類する．  
`potential_inserted_lines`のうち`potential_deleted_lines`にも入っている->`modified_lines`.  
`potential_inserted_lines`のうち`potential_deleted_lines`に入っていない->`inserted_lines`.  
`potential_deleted_lines`のうち`potential_inserted_lines`に入っていない->`deleted_lines`.  

実際のコード
```python
def find_moving_lines(commit: git.Commit, name: str) -> dict:
    return_result = {}
    for parent_commit in commit.parents:
        diff_hunks = parent_commit.diff(commit, create_patch=True)
        output_result = []
        for diff_hunk in diff_hunks:
            if diff_hunk.diff:
                child_path = diff_hunk.b_path
                parent_path = diff_hunk.a_path
                try:
                    result = parse_diff_str(diff_hunk.diff.decode("utf-8"))
                    if result is None:
                        continue
                except UnicodeDecodeError:
                    print(f"diff.diff.decode('utf-8')のデコードに失敗しました．")
                    print(diff_hunk.diff)
                    continue
                hunk, old_file_line_count, new_file_line_count = result
                potential_inserted_lines = []
                potential_deleted_lines = []
                for line in hunk:
                    if line.startswith("+"):
                        potential_inserted_lines.append(new_file_line_count)
                        new_file_line_count += 1
                    elif line.startswith("-"):
                        potential_deleted_lines.append(old_file_line_count)
                        old_file_line_count += 1
                    else:
                        old_file_line_count += 1
                        new_file_line_count += 1
                inserted_lines = []
                deleted_lines = []
                modified_lines = []
                for inserted_line in potential_inserted_lines:
                    if inserted_line not in potential_deleted_lines:
                        inserted_lines.append(inserted_line)
                    else:
                        modified_lines.append(inserted_line)
                for deleted_line in potential_deleted_lines:
                    if deleted_line not in potential_inserted_lines:
                        deleted_lines.append(deleted_line)
                output_result.append({
                    "child_path": child_path,
                    "parent_path": parent_path,
                    "inserted_lines": inserted_lines,
                    "deleted_lines": deleted_lines,
                    "modified_lines": modified_lines
                })
```


# 行の対応
親コミットと子コミットのコードクローンの対応を取るために，親コミットと子コミットの行を対応する．子コミットの行数をkey，親コミットの行数をvalueにしたDictで管理する．
挿入行のkeyに対応するvalueは`None`にする，また，削除行がある場合はvalueをずらす．
```python
    def _correspond_lines(self, line_diffs: list[dict], child_filemap: FileMapper, parent_filemap: FileMapper):
        result = {}
        for diff in line_diffs:
            child_path = diff["child_path"]
            child_file_loc = child_filemap.get_file_loc(child_path)
            if child_file_loc == -1:
                continue
            parent_path = diff["parent_path"]
            parent_file_loc = parent_filemap.get_file_loc(parent_path)
            if parent_file_loc == -1:
                continue
            if child_path != parent_path:
                continue
            if child_path in result.keys():
                if len(diff["inserted_lines"]) > 0:
                    for inserted_line in diff["inserted_lines"]:
                        tmp1 = result[child_path]["lines"][inserted_line]
                        result[child_path]["lines"][inserted_line] = None
                        for l in range(inserted_line+1, child_file_loc+1):
                            tmp2 = result[child_path]["lines"][l]
                            result[child_path]["lines"][l] = tmp1
                            tmp1 = tmp2
                if len(diff["deleted_lines"]) > 0:
                    for child_line in result[child_path]["lines"].keys():
                        if result[child_path]["lines"][child_line] in diff["deleted_lines"]:
                            for l in range(child_line, child_file_loc):
                                result[child_path]["lines"][l] = result[child_path]["lines"][l+1]
                            if child_file_loc+1 in result[child_path]["lines"].keys():
                                result[child_path]["lines"][child_file_loc] = result[child_path]["lines"][child_file_loc+1]
                                l = child_file_loc+1
                                while True:
                                    if l in result[child_path]["lines"].keys():
                                        result[child_path]["lines"].pop(l)
                                        l += 1
                                    else:
                                        break
                            else:
                                result[child_path]["lines"][child_file_loc] = child_file_loc
            else:   
                lines = {}
                if len(diff["inserted_lines"]) > 0:
                    parent_line = 1
                    for l in range(1, child_file_loc+1):
                        if l in diff["inserted_lines"]:
                            lines[l] = None
                        else:
                            lines[l] = parent_line
                            parent_line += 1
                if len(diff["deleted_lines"]) > 0:
                    child_line = 1
                    for l in range(1, parent_file_loc+1):
                        if l not in diff["deleted_lines"]:
                            lines[child_line] = l
                            child_line += 1
                elif len(diff["modified_lines"]) > 0:
                    child_line = 1
                    for l in range(1, parent_file_loc+1):
                        lines[child_line] = parent_line
                else:
                    continue
                result[child_path] = {
                    "lines": lines
                }
        return result
```


